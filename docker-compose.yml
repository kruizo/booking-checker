# Docker Compose for Booking Conflict Checker
# Development and Production configurations

services:
  # ==========================================
  # Nginx Web Server
  # ==========================================
  nginx:
    image: nginx:alpine
    container_name: booking-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./backend/docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./backend/docker/locations.conf:/etc/nginx/conf.d/locations.conf:ro
      - ./backend/public:/var/www/html/public:ro
      - ./frontend/dist:/var/www/html/frontend/dist:ro
    depends_on:
      - backend
    networks:
      - booking-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # Laravel Backend (PHP-FPM)
  # ==========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: booking-backend
    restart: unless-stopped
    environment:
      - APP_NAME=BookingChecker
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_URL=${APP_URL:-http://localhost}
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/var/www/html/database/database.sqlite
      - SESSION_DRIVER=database
      - SESSION_DOMAIN=${SESSION_DOMAIN:-localhost}
      - SANCTUM_STATEFUL_DOMAINS=${SANCTUM_STATEFUL_DOMAINS:-localhost,localhost:80,127.0.0.1}
      - CACHE_STORE=file
      - QUEUE_CONNECTION=sync
      - LOG_CHANNEL=stderr
    volumes:
      - backend-storage:/var/www/html/storage
      - backend-database:/var/www/html/database
    networks:
      - booking-network
    healthcheck:
      test: ["CMD", "php-fpm", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==========================================
  # Frontend Builder (for development)
  # ==========================================
  frontend:
    image: node:20-alpine
    container_name: booking-frontend
    working_dir: /app
    profiles:
      - dev
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
    ports:
      - "5173:5173"
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    networks:
      - booking-network

  # ==========================================
  # Laravel Scheduler (for cron jobs)
  # ==========================================
  scheduler:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: booking-scheduler
    restart: unless-stopped
    profiles:
      - production
    environment:
      - APP_ENV=production
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/var/www/html/database/database.sqlite
    volumes:
      - backend-storage:/var/www/html/storage
      - backend-database:/var/www/html/database
    command: sh -c "while true; do php artisan schedule:run --verbose --no-interaction; sleep 60; done"
    networks:
      - booking-network
    depends_on:
      - backend

  # ==========================================
  # Queue Worker (if using queues)
  # ==========================================
  queue:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: booking-queue
    restart: unless-stopped
    profiles:
      - production
    environment:
      - APP_ENV=production
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/var/www/html/database/database.sqlite
      - QUEUE_CONNECTION=database
    volumes:
      - backend-storage:/var/www/html/storage
      - backend-database:/var/www/html/database
    command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600
    networks:
      - booking-network
    depends_on:
      - backend

# ==========================================
# Volumes
# ==========================================
volumes:
  backend-storage:
    driver: local
  backend-database:
    driver: local
  frontend-node-modules:
    driver: local

# ==========================================
# Networks
# ==========================================
networks:
  booking-network:
    driver: bridge
